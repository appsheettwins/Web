<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡πÇ‡∏°‡∏ó‡∏ô‡∏≤‡∏ö‡∏±‡∏ï‡∏£</title>

<!-- LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  font-family:'Prompt',sans-serif;
  background:#f2f5f9;
  margin:0;
}
.container{
  max-width:480px;
  margin:auto;
  padding:15px;
}
.card{
  background:#fff;
  border-radius:16px;
  padding:20px;
  box-shadow:0 5px 20px rgba(0,0,0,.08);
}
h2{text-align:center;margin-top:0}
label{display:block;margin-top:12px;font-weight:600}
input,select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:16px;
}
.btn{
  width:100%;
  padding:14px;
  margin-top:16px;
  border:none;
  border-radius:12px;
  background:#4a90e2;
  color:#fff;
  font-size:18px;
}
.hidden{display:none}

/* Certificate */
.certificate{
  margin-top:20px;
  padding:20px;
  border-radius:18px;
  text-align:center;
}
.thai{background:#fffbe6;border:3px solid #d4af37}
.modern{background:#eef3ff;border:3px solid #4a90e2}
.nature{background:#f0fff4;border:3px solid #2ecc71}

.cert-header{font-size:2.3em;font-weight:bold}
.cert-name{margin:10px 0;font-weight:bold}
.cert-amount{margin:12px 0;font-weight:bold}
.cert-footer{margin-top:15px}
.profile{
  width:90px;height:90px;
  border-radius:50%;
  margin-bottom:10px;
}
.theme-btns button{
  margin:5px;
  padding:10px 14px;
  border-radius:10px;
  border:none;
}
</style>
</head>

<body>
<div class="container">

<!-- FORM -->
<div class="card" id="formSection">
<h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç</h2>

<label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç</label>
<input id="name">

<label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
<input id="amount" type="number">

<label>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
<select id="purpose"></select>

<button class="btn" onclick="saveDonation()">‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡πÇ‡∏°‡∏ó‡∏ô‡∏≤‡∏ö‡∏±‡∏ï‡∏£</button>
</div>

<!-- CERTIFICATE -->
<div class="card hidden" id="certSection">

<div class="theme-btns" style="text-align:center">
<button onclick="setTheme('thai')">üáπüá≠ ‡πÑ‡∏ó‡∏¢</button>
<button onclick="setTheme('modern')">‚ú® ‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢</button>
<button onclick="setTheme('nature')">üåø ‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥</button>
</div>

<div id="certificate" class="certificate thai"></div>

<button class="btn" onclick="downloadImage()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</button>
<button class="btn" style="background:#999" onclick="resetForm()">‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>

</div>

</div>

<script>
/* ===== CONFIG ===== */
const scriptUrl = "https://script.google.com/macros/s/AKfycby9pH_JP8PpdGWzazdTjZw72hhsKnj_Uzd0TI-kHidhuK7qI4vmPMq-CspmaoHcKITQ/exec";
const liffId = "2008940385-4hmfE7UE";

/* ===== STATE ===== */
let profile = {name:'',picture:''};
let currentTheme='thai';

/* ===== INIT ===== */
window.onload = async ()=>{
  await initLIFF();
  loadPurposes();
};

/* ===== LIFF ===== */
async function initLIFF(){
  await liff.init({ liffId });
  if(!liff.isLoggedIn()){
    liff.login();
    return;
  }
  const p = await liff.getProfile();
  profile.name = p.displayName;
  profile.picture = p.pictureUrl;
  name.value = p.displayName;
}

/* ===== LOAD PURPOSE ===== */
function loadPurposes(){
 fetch(scriptUrl+"?action=getPurposes")
 .then(r=>r.json())
 .then(d=>{
   purpose.innerHTML="";
   d.purposes.forEach(p=>{
     let o=document.createElement("option");
     o.textContent=p;
     purpose.appendChild(o);
   });
 });
}

/* ===== SAVE ===== */
function saveDonation(){
 if(!name.value||!amount.value){
   alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
   return;
 }
 const fd=new FormData();
 fd.append("name",name.value);
 fd.append("amount",amount.value);
 fd.append("purpose",purpose.value);
 fd.append("lineName",profile.name);
 fd.append("linePicture",profile.picture);

 fetch(scriptUrl,{method:"POST",body:fd});

 formSection.classList.add("hidden");
 certSection.classList.remove("hidden");
 renderCert();
}

/* ===== CERTIFICATE ===== */
function setTheme(t){
 currentTheme=t;
 renderCert();
}

function renderCert(){
 certificate.className="certificate "+currentTheme;
 certificate.innerHTML=`
 <img src="${profile.picture}" class="profile">
 <div class="cert-header">‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡πÇ‡∏°‡∏ó‡∏ô‡∏≤‡∏ö‡∏±‡∏ï‡∏£</div>
 <div>‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏Å‡∏Ç‡∏µ‡∏û‡∏¢‡∏≤‡∏ô‡∏ß‡πà‡∏≤</div>
 <div class="cert-name">${profile.name}</div>
 <div>‡πÑ‡∏î‡πâ‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç ${purpose.value}</div>
 <div class="cert-amount">${Number(amount.value).toLocaleString()} ‡∏ö‡∏≤‡∏ó</div>
 <div class="cert-footer">
 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH')}<br>
 üôè ‡∏™‡∏≤‡∏ò‡∏∏ üôè
 </div>
 `;
}

/* ===== IMAGE ===== */
function downloadImage(){
 html2canvas(certificate).then(canvas=>{
   const a=document.createElement("a");
   a.href=canvas.toDataURL("image/png");
   a.download="certificate.png";
   a.click();
 });
}

/* ===== RESET ===== */
function resetForm(){
 certSection.classList.add("hidden");
 formSection.classList.remove("hidden");
}
</script>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</body>
</html>
